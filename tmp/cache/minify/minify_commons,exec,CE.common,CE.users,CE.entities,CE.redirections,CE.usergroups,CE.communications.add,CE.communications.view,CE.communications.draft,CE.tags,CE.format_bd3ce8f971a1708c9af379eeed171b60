var c=function(a){console.log(a);};var WEBROOT='/AIG_mensajeria/';function message(title,text){$.gritter.add({title:title,text:text,image:false,sticky:false,time:'',class_name:'gritter-success'});};function dialog(message,fun,params,btn1,btn2){if(!btn1)btn1='Aceptar';if(!btn2)btn2='Cancelar';bootbox.dialog({message:"<span class='bigger-110'>"+message+"</span>",buttons:{"success":{"label":btn1,"className":"btn-sm btn-success","callback":fun(params)},"button":{"label":btn2,"className":"btn-sm"}}});}
function m_error(message){var funHtml=function(message){var html='<div id="msg-error">';html=html+'<div id="gritter-item-4" class="gritter-item-wrapper gritter-error gritter-center">'
html=html+'<div class="gritter-top"></div>';html=html+'<div class="gritter-item">';html=html+'<div id="m-close">';html=html+'<i class="icon-remove bigger-110"></i>';html=html+'</div>';html=html+'<div class="gritter-without-image">';html=html+'<span class="gritter-title">Alerta</span>';html=html+'<p>'+message+'</p>';html=html+'</div>';html=html+'<div style="clear:both"></div>';html=html+'</div>';html=html+'<div class="gritter-bottom"></div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';return html;}
var hatmA=funHtml(message);$('body').prepend(hatmA);var removeMsg=function(){$('#msg-error').fadeOut('fast',function(){$('#msg-error').remove();});};var prueba=setTimeout(function(){removeMsg();},4000);$("#msg-error").on("mouseenter",function(){clearTimeout(prueba);$('#msg-error').stop();}).on("mouseleave",function(){setTimeout(function(){removeMsg();},4000);});$('#m-close i').on('click',function(){event.preventDefault();removeMsg();});}
function prettydate(){$.each($('.pretty-date-date'),function(index,val){var months=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];var dateTime=$(val).attr('data-date');if(!dateTime)return false;var arrDate=dateTime.split(' ');var date=arrDate[0].split('-');var hours=arrDate[1].split(':');var day=parseInt(date[2]);var month=parseInt(date[1]);var year=date[0].slice(-2);var hour=parseInt(hours[0]);var min=hours[1];var sec=hours[2];var meridiam=(hour>=12)?'pm':'am';hour=(hour>12)?parseInt(hour-12):parseInt(hour);$(val).find('.day').html(day);$(val).find('.month').html(months[month-1]);$(val).find('.year').html(year);$(val).find('.hour').html(hour+':'+min+' '+meridiam);$(val).find('.full-date').html('<strong>'+day+' '+months[month-1]+' '+year+'</strong> '+hour+':'+min+' '+meridiam);var fullD='Leído el '+day+' de '+months[month-1]+' de '+year+' a las '+hour+':'+min+' '+meridiam;$(val).find('.full-date-title').attr('data-original-title',fullD);if($(val).find('.email-date').length>0){var today=$('body').attr('data-today');if(!today)return false;var arrDateT=today.split(' ');var dateT=arrDateT[0].split('-');var hoursT=arrDateT[1].split(':');var dayT=parseInt(dateT[2]);var monthT=parseInt(dateT[1]);var yearT=dateT[0].slice(-2);var hourT=parseInt(hoursT[0]);var minT=hoursT[1];var secT=hoursT[2];var meridiamT=(hourT>=12)?'pm':'am';hourT=(hourT>12)?parseInt(hourT-12):parseInt(hourT);var show='';if(yearT!=year){show=day+'/'+months[month-1]+'/'+year;}
else if(dayT==day&&monthT==month){show=hour+':'+min+' '+meridiam;}
else{show=day+' '+months[month-1];}
$(val).find('.email-date').html(show);}});}
$(document).ready(function(){$(document).on('keydown','.only-numbers',function(e){if((event.keyCode<48||event.keyCode>57)&&event.keyCode!=110&&event.keyCode!=8&&event.keyCode!=37&&event.keyCode!=38&&event.keyCode!=39&&event.keyCode!=40&&event.keyCode!=190&&event.keyCode!=46){if((event.keyCode<96||event.keyCode>105)){return false;}}});var notificationCommunications=function(){$.ajax({url:WEBROOT+'communications/getNewCommunications',type:"GET",success:function(data){var _li=$('#notification-new-communications');var html='';if(data.Count>0){html=html+'<a data-toggle="dropdown" class="dropdown-toggle" href="#">';html=html+'<i class="icon-envelope icon-animated-vertical"></i>';html=html+'<span class="badge badge-success">'+data.Count+'</span>';html=html+'</a>';html=html+'<ul class="pull-right dropdown-navbar dropdown-menu dropdown-caret dropdown-close">';html=html+'<li class="dropdown-header"><i class="icon-envelope-alt"></i>'+data.Count+' Notificaciones</li>';$.each(data.Messages,function(index,message){html=html+'<li><a href="'+WEBROOT+'communications/view/'+message.Communication.id+'">';html=html+'<div class="msg-title">';html=html+'<div class="blue" style="width:220px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">'+message.SenderEntity.name+'</div>';html=html+'<div style="width:220px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">'+message.Message.title+'</div>';html=html+'</div>';html=html+'<div style="margin: 5px; text-align:right;"><span class="msg-time pretty-date-date" data-date="'+message.Message.created+'"><span class="email-date"></span></span></div>';html=html+'</a></li>';});html=html+'<li><a href="'+WEBROOT+'communications'+'">Bandeja de comunicaciones</a></li>';html=html+'</ul>';}
else{html=html+'<a data-toggle="dropdown" class="dropdown-toggle" href="#">';html=html+'<i class="icon-envelope icon-animated-vertical"></i>';html=html+'<span class="badge badge-success">0</span>';html=html+'</a>';html=html+'<ul class="pull-right dropdown-navbar dropdown-menu dropdown-caret dropdown-close">';html=html+'<li><a href="'+WEBROOT+'communications'+'">Bandeja de comunicaciones</a></li>';html=html+'</ul>';}
$(_li).html(html);prettydate();},dataType:"json",complete:setTimeout(function(){notificationCommunications()},5000),timeout:2000})};prettydate();var groupUserId=$('body').data('user-group-id');if(groupUserId!=1&&groupUserId!=3)
setTimeout(function(){notificationCommunications()},3000);$(document.body).tooltip({selector:'[title]'}).on('click mouseenter mouseleave','[title]',function(ev){$(this).tooltip('mouseenter'===ev.type?'show':'hide');});});CE={common:{},entities:{},users:{},user_groups:{},communications:{},tags:{},redirections:{},formats:{},htmls:{},};UTIL={exec:function(controller,action){var ns=CE,action=(action===undefined)?"init":action;c('['+controller+']['+action+']');if(controller!==""&&ns[controller]&&typeof ns[controller][action]=="function"){ns[controller][action]();}},init:function(){var body=document.body,controller=body.getAttribute("data-controller").toLowerCase(),action=body.getAttribute("data-action").toLowerCase();UTIL.exec('common');UTIL.exec(controller);UTIL.exec(controller,action);}};$(document).ready(UTIL.init);;$.extend(CE.common,{init:function(){var idUser=$('body').attr('data-user-id');$(document).on('click','#savePasswordFirstTime',function(event){event.preventDefault();var data={password:$('#password').val(),cpassword:$('#cpassword').val()};$.ajax({url:WEBROOT+'setPassword',type:'post',data:data,success:function(data){if(data.Request.status=='200'){$('#modalChangePassFirstTime').modal('hide');message('Mensaje',data['Request']['message']);}
else{m_error(data['Request']['message']);}},dataType:'json',});});}});;$.extend(CE.users,{adduser:function(){var _htmlSelect=function(entities){var html='<div class="form-group">';html=html+'<label class="col-sm-3 control-label no-padding-right text-right" for="form-field-1">&nbsp;</label>';html=html+'<div class="col-sm-9">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(entities,function(index,entity){var child=entity.ChildEntity;child=child.length;child=(child>0)?1:'';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select></div></div>';return html;}
$(document).on('change','select.s-entity',function(){_this=this;_opt=$(_this).find('option:selected');var hasChild=$(_opt).attr('data-child');var parentId=$(_opt).attr('value');var userGroupId=$('#UserUserGroupId').val();$(_this).parents('.form-group:first').nextAll('.form-group').remove();if(hasChild&&userGroupId!=3){$('.selects-entity').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+parentId+'/',type:'get',success:function(data){var htmlSelect=_htmlSelect(data);$('.selects-entity').find('div.form-group:last').after(htmlSelect);},dataType:'json',complete:function(){$('.selects-entity').find('.i-load').addClass('hide');}});}});$('#addUser').on('click',function(event){event.preventDefault();var cleanAll=function(){$('#UserUsername').val('');$('#UserUserGroupId').find('option:first').attr('selected','selected');$('#UserFirstName').val('');$('#UserLastName').val('');$('#UserEmail').val('');$('#UserTelephone').val('');$('#UserCelphone').val('');$('#UserCpassword').val('');$('#UserPassword').val('');$('.selects-entity').find('.form-group:first').nextAll('.form-group').remove();$('.selects-entity .form-group:first').find('option:first').attr('selected','selected');$('#UserGroupId').find('option:first').attr('selected','selected');};var username=$('#UserUsername').val();var group=$('#UserUserGroupId').val();var name=$('#UserFirstName').val();var lastName=$('#UserLastName').val();var email=$('#UserEmail').val();var password=$('#UserPassword').val();var cpassword=$('#UserCpassword').val();var telephone=$('#UserTelephone').val();var celphone=$('#UserCelphone').val();var entity=$('option.opt-entity:selected:last').val();var groupId=$('#UserGroupId').val();if(!username||!group||group==0||!entity||entity==0||!name||!lastName||!email||!password||!cpassword){m_error('Debe llenar todos los campos');return false;}
if(password!=cpassword){m_error('Las contraseñas no coinciden');return false;}
var user={username:username,user_group_id:group,first_name:name,last_name:lastName,email:email,password:password,cpassword:cpassword,entity_id:entity,celphone:celphone,telephone:telephone,group_id:groupId}
$.ajax({url:WEBROOT+'addUser/',type:'post',data:user,success:function(data){if(data.Request.status==300){m_error(data.Request.message);return false;}
message(data.Request.message);cleanAll();},dataType:'json',error:function(x,v){c(x);c(v);}});});},edituser:function(){var _htmlSelect=function(entities){var html='<div class="form-group">';html=html+'<label class="col-sm-3 control-label no-padding-right text-right" for="form-field-1">&nbsp;</label>';html=html+'<div class="col-sm-9">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(entities,function(index,entity){var child=entity.ChildEntity;child=child.length;child=(child>0)?1:'';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select></div></div>';return html;}
$(document).on('change','select.s-entity',function(){_this=this;_opt=$(_this).find('option:selected');var hasChild=$(_opt).attr('data-child');var parentId=$(_opt).attr('value');$(_this).parents('.form-group:first').nextAll('.form-group').remove();if(hasChild){$('.selects-entity').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+parentId+'/',type:'get',success:function(data){var htmlSelect=_htmlSelect(data);$('.selects-entity').find('div.form-group:last').after(htmlSelect);},dataType:'json',complete:function(){$('.selects-entity').find('.i-load').addClass('hide');}});}});$('#editUser').on('click',function(event){event.preventDefault();var userId=$('#UserEditUserForm').attr('data-user-id');var username=$('#username').val();var group=$('#user_group_id').val();var name=$('#first_name').val();var lastName=$('#last_name').val();var email=$('#email').val();var telephone=$('#telephone').val();var celphone=$('#celphone').val();var entity=$('option.opt-entity:selected:last').val();var group=$('option.opt-group:selected:last').val();if(!username||!group||group==0||!entity||entity==0||!name||!lastName||!email){m_error('Debe llenar todos los campos');return false;}
var user={id:userId,username:username,user_group_id:group,first_name:name,last_name:lastName,email:email,celphone:celphone,telephone:telephone,entity_id:entity,group_id:group}
$.ajax({url:WEBROOT+'editUser/'+userId,type:'post',data:user,success:function(data){if(data.Request.status==300){m_error(data.Request.message);return false;}
var m={flash:{message:data.Request.message,element:'m_success',params:''}}
window.location.href=WEBROOT+'allUsers';},dataType:'json',error:function(x,v){c(x);c(v);}});});},index:function(){var filterUserByName=function(text){$.each($('tbody tr'),function(){var name=$(this).find('.td-name').attr('data-user-name');var username=$(this).find('.td-username').attr('data-user-username');var entity=$(this).find('.td-entity').attr('data-entity-name');var group=$(this).find('.td-group').attr('data-group-name');if(name||username||entity||group){name=name.toLowerCase();username=username.toLowerCase();entity=entity.toLowerCase();group=group.toLowerCase();if(name.match(text))$(this).fadeIn();else if(username.match(text))$(this).fadeIn();else if(entity.match(text))$(this).fadeIn();else if(group.match(text))$(this).fadeIn();else $(this).fadeOut();}})};var timer=0;$('#searchUser').keyup(function(){clearTimeout(timer);timer=setTimeout(function(){var q=$('#searchUser').val();filterUserByName(q);},250)});},directory:function(){var _htmlSelect=function(entities){var html='<div class="form-group">';html=html+'<label class="col-sm-1 control-label no-padding-right text-right" for="form-field-1">&nbsp;</label>';html=html+'<div class="col-sm-11">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(entities,function(index,entity){var child=entity.ChildEntity;child=child.length;child=(child>0)?1:'';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select></div></div>';return html;}
var _htmlTable=function(data){if(data.length<1)return'<thead><tr><th colspan="6"> No hay datos </th></tr></thead>';var html='<thead>';html=html+'<tr>';html=html+'<th class="center">'
html=html+'<label>';html=html+'<input type="checkbox" class="ace" id="checkbox-select-all"><span class="lbl"></span>';html=html+'</label>'
html=html+' </th>';html=html+'<th>Nombre</th><th>Teléfono</th><th>Móvil</th><th>Unidad</th><th>Web</th></tr></thead>';html=html+'<tbody>';$.each(data,function(index,val){telephone=val.User.telephone?val.User.telephone:' ';celphone=val.User.celphone?val.User.celphone:' ';website=val.Entity.website?val.Entity.website:' ';html=html+'<tr data-user-id="'+val.User.id+'">';html=html+'<td class="center"><label><input class="ace ckb" type="checkbox"><span class="lbl"></span></label></td>';html=html+'<td>'+val.User.first_name+' '+val.User.last_name+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+val.path+'</td>';if(website!=' ')html=html+'<td><a href="'+website+'" target="_blank"> Ver </a></td>';else html=html+'<td>&nbsp;</td>';});html=html+'</tbody>';return html;}
$(document).on('change','select.s-entity',function(){_this=this;_opt=$(_this).find('option:selected');var hasChild=$(_opt).attr('data-child');var parentId=$(_opt).attr('value');var userGroupId=$('#UserUserGroupId').val();$(_this).parents('.form-group:first').nextAll('.form-group').remove();if(hasChild&&userGroupId!=3){$('.selects-entity').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+parentId+'/',type:'get',success:function(data){var htmlSelect=_htmlSelect(data);$('.selects-entity').find('div.form-group:last').after(htmlSelect);},dataType:'json',complete:function(){$('.selects-entity').find('.i-load').addClass('hide');}});}});$('#btn-find-by-entity').on('click',function(){event.preventDefault();var entity=$('option.opt-entity:selected:last').val();$.ajax({url:WEBROOT+'entities/findAllPeople/'+entity+'/',type:'get',success:function(data){var _html=_htmlTable(data);$('#table-2').html(_html);},dataType:'json',});});$('#btn-find-by-group').on('click',function(){event.preventDefault();var group=$('option.opt-group:selected:last').val();$.ajax({url:WEBROOT+'groups/findPeopleByGoup/'+group+'/',type:'get',success:function(data){var _html=_htmlTable(data);$('#table-3').html(_html);},dataType:'json',});});$(document).on('click','table th input:checkbox',function(){var that=this;$(this).closest('table').find('tr > td:first-child input:checkbox').each(function(){this.checked=that.checked;$(this).closest('tr').toggleClass('selected');});});$(document).on('click','[type="checkbox"]',function(event){var active=false;$.each($('[type="checkbox"]'),function(index,val){if($(this).is(':checked')){active=true;return false;}});if(active)$('.spn-send-msg').removeClass('hide');else $('.spn-send-msg').addClass('hide');});$('.btn-send-msg').on('click',function(event){event.preventDefault();var arr=[];var txt='?';$("input[type=checkbox]:checked").each(function(){if($(this).attr('id')!='checkbox-select-all'){var id=$(this).parents('tr:first').attr('data-user-id');if(id)arr.push(id);txt=txt+'usrid[]='+id+'&'}});location.href=WEBROOT+'communications/add/'+txt;});}});;$.extend(CE.entities,{index:function(){var _htmlEntityLI=function(entity){var child=entity.ChildEntity;var hasusers=entity.User;var userGroupId=$('body').attr('data-user-group-id');child=child.length;hasusers=hasusers.length;child=(child>0)?1:0;hasusers=(hasusers>0)?1:0;var html='<li class="dd-item dd2-item" data-id="'+entity.Entity.id+'" data-parent-id="'+entity.Entity.parent_id+'" data-children="'+child+'">'
html=html+'<div class="dd2-content">';if(child&&userGroupId=='3'){html=html+'<span class="i-plus-entity m-hover"><i class="icon-plus"></i>&nbsp;</span>';html=html+'<span class="i-minus-entity m-hover"><i class="icon-minus "></i>&nbsp;</span>';}
html=html+entity.Entity.name;html=html+'<i class="i-load hide icon-refresh icon-spin blue"></i>'
if(!hasusers&&!child){html=html+'<i class="delete-entity icon-trash pull-right bigger-130 m-hover red" title="Eliminar esta entidad y toda su decendencia"></i>';}
if(userGroupId=='3'){html=html+'<i class="new-entity pull-right bigger-130 icon-plus-sign-alt m-hover orange2" title="Agregar nueva entidad a '+entity.Entity.name+'"></i>';}
html=html+'</div>';html=html+'</li>';return html;};var _htmlEntity=function(data){var html='<ol class="dd-list" style="">';$.each(data,function(index,entity){html=html+_htmlEntityLI(entity);});html=html+'</ol>';return html;};$(document).on('click','.i-plus-entity',function(event){_this=this;event.preventDefault();parentId=$(_this).parents('li').attr('data-parent-id');id=$(_this).parents('li').attr('data-id');if($(_this).parents('li').attr('open')){$(_this).hide();$(_this).parent('.dd2-content').find('.i-minus-entity').show();$(_this).parents('li:first').find('ol').show();return false;}
$(_this).parents('li:first').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+id+'/',type:'get',success:function(data){$(_this).parents('li').attr('open','true');$(_this).hide();$(_this).parent('.dd2-content').find('.i-minus-entity').show();var content=_htmlEntity(data);$(_this).parents('li[data-id="'+id+'"]').find('div.dd2-content').after(content);},dataType:'json',complete:function(){$(_this).parents('li:first').find('.i-load').addClass('hide');}});});$(document).on('click','.i-minus-entity',function(event){_this=this;event.preventDefault();$(_this).hide();$(_this).parent('.dd2-content').find('.i-plus-entity').show();$(_this).parents('li:first').find('ol').hide();});$(document).on('click','.delete-entity',function(event){event.preventDefault();_this=this;var entityId=$(_this).parents('li:first').attr('data-id');bootbox.dialog({message:"<span class='bigger-110'>Si elimina esta entidad, todas las entidades descendentes también serán eliminadas. Desea continuar?</span>",buttons:{"success":{"label":'Si',"className":"btn-sm btn-success","callback":function(){$.ajax({url:WEBROOT+'entities/delete/'+entityId,type:'post',success:function(data){message('Mensaje',data['Request']['message']);$(_this).parents('li:first').remove();},dataType:'json',});}},"button":{"label":'No',"className":"btn-sm"}}});});$(document).on('click','.new-entity',function(event){_this=this;event.preventDefault();var entityId=$(_this).parents('li:first').attr('data-id');if(!entityId)entityId=1;$('#modalNewEntity').modal('show');$('#modalNewEntity').attr('data-entity-id',entityId);$('#modalNewEntity').find('#name').val('');$('#modalNewEntity').find('#description').val('');});$('#btnSaveNewEntity').on('click',function(event){event.preventDefault();_modal=$('#modalNewEntity');var entityId=$(_modal).attr('data-entity-id');var url=domainRegex=/[^w{3}\.]([a-zA-Z0-9]([a-zA-Z0-9\-]{0,65}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}/igm;var website=$(_modal).find('#website').val();var name=$(_modal).find('#name').val();if(!name){m_error('Debe colocar el nombre de la entidad');return false;}
if(!website.match(url)){m_error('La direccion del sitio Web no es válido. No debe colocar la expresión "http://" ');return false;}
var newEntity={name:name,website:'http://'+website,description:$(_modal).find('#description').val(),parent_id:entityId,active:1};$.ajax({url:WEBROOT+'entities/add/',type:'post',data:newEntity,success:function(data){$(_modal).modal('hide');message('Mensaje',data['Request']['message']);if(entityId==1){var html=_htmlEntityLI(data);$('#mainList').append(html);return false;}
var ol=$('li[data-id="'+entityId+'"]').find('ol');ol=ol.length;if(ol>0){var html=_htmlEntityLI(data);$('li[data-id="'+entityId+'"]').find('.i-plus-entity:first').click();$('li[data-id="'+entityId+'"]').find('ol:first').append(html);}
else{var aux={out:data,}
var html=_htmlEntity(aux);var auxHtml='<span class="i-plus-entity m-hover" style="display:none;"><i class="icon-plus"></i>&nbsp;</span>';auxHtml=auxHtml+'<span class="i-minus-entity m-hover" style="display:inline;"><i class="icon-minus "></i>&nbsp;</span>';$('li[data-id="'+entityId+'"]').find('div:first').prepend(auxHtml);$('li[data-id="'+entityId+'"]').append(html);$('li[data-id="'+entityId+'"]').attr('open','open');}},dataType:'json',});});},add:function(){}});;$.extend(CE.redirections,{index:function(){var _htmlTr=function(data){var html='<tr data-new="true" data-type="'+data.type+'" data-id="'+data.id+'">';html=html+'<td data-type="'+data.type+'" data-id="'+data.id+'">'+data.name+'</td>';html=html+'<td>'+data.path+'</td>';html=html+'<td class="center redirection-delete"><a href="#">Eliminar</a></td>';html=html+'</tr>';return html;}
var url=WEBROOT+'communications/findUsersAndEntities/all/'
$('#msg-redirect').tagsManager({preventSubmitOnEnter:true,typeahead:true,typeaheadSource:function(query,process){$.post(url,{q:query},function(data){process($.map(data,function(item){var name=item.id+'--'+item.name+'--'+item.type+'--'+item.path;return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'<div class="bx-path">'+path+'</div>';html=html+'</div>';html=html+'</div>';return html},this.updater=function(item){var sp=item.split('--');var path=sp[3].split('-');var userLogged=$('body').attr('data-user-id');var element={'id':sp[0],'name':sp[1],'type':sp[2],'path':sp[3]+' -'};var toSave={to_user_id:sp[0],type:sp[2],}
var error=false;$.ajax({url:WEBROOT+'redirections/add/',type:'post',data:toSave,success:function(data){if(data['Request']['status']==200){message('Mensaje',data['Request']['message']);}
else{m_error(data['Request']['message']);}},dataType:'json',});var htmlTr=_htmlTr(element);$('.to-redirect').append(htmlTr);}},});$(document).on('click','.redirection-delete',function(event){event.preventDefault();var tr=$(this).parent('tr');var type=$(tr).attr('data-type');var trNew=$(tr).attr('data-new');var isNew=(trNew)?'true':'false';var idRedirection=$(this).parent('tr').attr('data-id');var data={'to_user_id':idRedirection,'from_user_id':$('body').attr('data-user-id'),'new':isNew,'type':type}
$.ajax({url:WEBROOT+'redirections/delete/'+idRedirection+'/',type:'post',data:data,success:function(data){if(data['Request']['status']==200){message('Mensaje',data['Request']['message']);$(tr).remove();}
else{m_error(data['Request']['message']);}},dataType:'json',});});},});;$.extend(CE.user_groups,{index:function(){$('.delete-group').on('click',function(event){event.preventDefault();var groupId=$(this).attr('data-group-id');bootbox.dialog({message:"<span class='bigger-110'>Eliminará el grupo de usuario. Desea continuar?</span>",buttons:{"success":{"label":'Si',"className":"btn-sm btn-success","callback":function(){$.ajax({url:WEBROOT+'deleteGroup/'+groupId,type:'post',success:function(data){if(data.Request.status==200){window.location.href=WEBROOT+'allGroups';}
else{m_error(data.Request.message);return false;}},dataType:'json',});}},"button":{"label":'No',"className":"btn-sm"}}});});}});;$.extend(CE.communications,{addcommon:function(){function showErrorAlert(reason,detail){var msg='';if(reason==='unsupported-file-type'){msg="Unsupported format "+detail;}
else{console.log("error uploading file",reason,detail);}
$('<div class="alert"> <button type="button" class="close" data-dismiss="alert">&times;</button>'+'<strong>File upload error</strong> '+msg+' </div>').prependTo('#alerts');}
var randomm=function(X){return Math.floor(X*(Math.random()%1));};var randomBetween=function(MinV,MaxV){r=randomm(MaxV-MinV+1);return MinV+r;};var ramdonString=function(){var str='';for(i=0;i<4;i++){str=str+randomBetween(10,99);}
return str;};var url=WEBROOT+'communications/findUsersAndEntities'
$('#prueba').tagsManager({preventSubmitOnEnter:true,typeahead:true,typeaheadSource:function(query,process){$.post(url,{q:query},function(data){process($.map(data,function(item){var name=item.id+'--'+item.name+'--'+item.type+'--'+item.path+'--to';return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'<div class="bx-path">'+path+'</div>';html=html+'</div>';html=html+'</div>';return html}
this.updater=function(item){$('span[rel="tooltip"]').tooltip('show');}},});$('#cc').tagsManager({preventSubmitOnEnter:true,typeahead:true,typeaheadSource:function(query,process){$.post(url,{q:query},function(data){process($.map(data,function(item){var name=item.id+'--'+item.name+'--'+item.type+'--'+item.path+'--cc';return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'<div class="bx-path">'+path+'</div>';html=html+'</div>';html=html+'</div>';return html}
this.updater=function(item){$('span[rel="tooltip"]').tooltip('show');}},});$('.btn-fileup').on('click',function(){$('.btn-fileup-h').click();});$('#message-content').ace_wysiwyg({toolbar:['font',null,'fontSize',null,{name:'bold',className:'btn-info'},{name:'italic',className:'btn-info'},{name:'strikethrough',className:'btn-info'},{name:'underline',className:'btn-info'},null,{name:'insertunorderedlist',className:'btn-success'},{name:'insertorderedlist',className:'btn-success'},{name:'outdent',className:'btn-purple'},{name:'indent',className:'btn-purple'},null,{name:'justifyleft',className:'btn-primary active'},{name:'justifycenter',className:'btn-primary'},{name:'justifyright',className:'btn-primary'},{name:'justifyfull',className:'btn-inverse'},null,{name:'createLink',className:'btn-pink'},{name:'unlink',className:'btn-pink'},null,null,null,'foreColor',null,null,null],'wysiwyg':{fileUploadError:showErrorAlert}}).prev().addClass('wysiwyg-style2');$('[data-toggle="buttons"] .btn').on('click',function(e){var target=$(this).find('input[type=radio]');var which=parseInt(target.val());var toolbar=$('#message-content').prev().get(0);if(which==1||which==2||which==3){toolbar.className=toolbar.className.replace(/wysiwyg\-style(1|2)/g,'');if(which==1)$(toolbar).addClass('wysiwyg-style1');else if(which==2)$(toolbar).addClass('wysiwyg-style2');}});var idTemporalRamdon=ramdonString();$('#txtIdMessage').val(idTemporalRamdon);$('.btn-fileup-h').on('change',function(event){setTimeout(function(){$.each($('.table-documents tr'),function(index,tr){$(tr).find('td .btn-start-preupload').click();});},500);});$(document).on('click','.myTagRemover',function(event){var traceId=$(this).attr('data-trace-id');if(traceId){var communicationId=$('#communication').attr('data-communication-id');var userId=$(this).parents('.myTag:first').attr('data-id');var data={communication_id:communicationId,user_id:userId,trace_id:traceId,}
$.ajax({url:WEBROOT+'traces/delete/'+traceId+'/',type:'post',data:data,success:function(data){if(data.Request.status==200){$(_tag).parents('.tag').remove();}},dataType:'json',});}
else{$(this).parents('.myTag').remove();}});},add:function(){CE.communications.addcommon();$(document).on('click','.rm-nw',function(event){event.preventDefault();$(this).parent('span').remove();});var userId=$('body').data('user-id');var tag_input=$('#pruebados');if(!(/msie\s*(8|7|6)/.test(navigator.userAgent.toLowerCase()))){tag_input.tag({placeholder:tag_input.attr('placeholder'),source:function(query,process){$.post(WEBROOT+'tags/findTags',{q:query,user_id:userId},function(data){process($.map(data,function(item){var name=item.Tag.id+'--'+item.Tag.name;return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'</div>';html=html+'</div>';return html}},});}
else{tag_input.after('<textarea id="'+tag_input.attr('id')+'" name="'+tag_input.attr('name')+'" rows="3">'+tag_input.val()+'</textarea>').remove();}
$('#btn-send-message').on('click',function(event){event.preventDefault();var _btn=this;var btnHtml=$(_btn).html();if($(_btn).attr('disabled'))return false;$(_btn).html('Enviando...');$(_btn).attr('disabled','disabled');$('.btn-fileup').hide();var receivers=[];var receiverscc=[];var files=[];var tags=[];var formats=[];var error=false;if($('#content-receivers > span').length<1){m_error('Debe indicar a quien o quienes va dirigido la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
if(!$('#message-title').val()){m_error('Debe colocar el asunto de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
if(!$('#message-category').val()){m_error('Debe indicar la categoría de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
if(!$('#message-type').val()){m_error('Debe indicar el tipo de comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
if(!$('input[name="message-action"]:checked').val()){m_error('Debe indicar la acción que requiere el envío de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
$.each($('.files tr'),function(index,file){var idFile=$(file).attr('data-file-id');files.push(idFile);});$.each($('#content-receivers .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'to',};receivers.push(r);});$.each($('#content-receivers-cc .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'cc',};receivers.push(r);});$.each($('#contentTags .tag'),function(index,span){var tag=$(span).html();var aux=tag.split('<button');tags.push(aux[0]);});$.each($('#tbl-formats tr'),function(index,tr){var id=$(tr).attr('data-document-id');formats.push(id);});var m_private=0;if($('#id-private-message').is(':checked'))m_private=1;var communication={user_id:$('body').attr('data-user-id'),entity_id:$('body').attr('data-user-entity-id'),title:$('#message-title').val(),content:$('#message-content').html(),receivers:receivers,files:files,temporal_id:$('#txtIdMessage').val(),communication_category_id:$('#message-category').val(),communication_type_id:$('#message-type').val(),tags:tags,formats:formats,action:$('input[name="message-action"]:checked').val(),message_private:m_private,draft:0,}
$.ajax({url:WEBROOT+'communications/add/',type:'post',data:communication,success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'communications/';}
else{m_error(data['Request']['message']);$.each($('.files tr'),function(index,tr){$(tr).find('.delete button').click();});$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();}},dataType:'json',});});$('#btn-send-draft').on('click',function(event){event.preventDefault();var _btn=this;var btnHtml=$(_btn).html();if($(_btn).attr('disabled'))return false;$(_btn).html('Enviando...');$(_btn).attr('disabled','disabled');$('.btn-fileup').hide();var receivers=[];var receiverscc=[];var files=[];var tags=[];var formats=[];var error=false;if(($('#content-receivers > span').length<1)&&!$('#message-title').val()){m_error('Debe indicar a quien o quienes va dirigido la comunicación y el asunto de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
$.each($('.files tr'),function(index,file){var idFile=$(file).attr('data-file-id');files.push(idFile);});$.each($('#content-receivers .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'to',};receivers.push(r);});$.each($('#content-receivers-cc .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'cc',};receivers.push(r);});$.each($('#contentTags .tag'),function(index,span){var tag=$(span).html();var aux=tag.split('<button');tags.push(aux[0]);});$.each($('#tbl-formats tr'),function(index,tr){var id=$(tr).attr('data-document-id');formats.push(id);});var m_private=0;if($('#id-private-message').is(':checked'))m_private=1;var communication={user_id:$('body').attr('data-user-id'),entity_id:$('body').attr('data-user-entity-id'),title:$('#message-title').val(),content:$('#message-content').html(),receivers:receivers,files:files,temporal_id:$('#txtIdMessage').val(),communication_category_id:$('#message-category').val(),communication_type_id:$('#message-type').val(),tags:tags,formats:formats,action:$('input[name="message-action"]:checked').val(),message_private:m_private,draft:1,}
$.ajax({url:WEBROOT+'communications/add/',type:'post',data:communication,success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'communications/';}
else{m_error(data['Request']['message']);$.each($('.files tr'),function(index,tr){$(tr).find('.delete button').click();});$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();}},dataType:'json',});});var _htmlDocuments=function(data){var _html='';$.each(data,function(index,val){data=val.Upload;description=val.Format.name;var html='<tr class="tr-format" data-document-id="'+data.id+'" data-document-name="'+data.description+'">';html=html+'<td>';html=html+'<a target="_blank" href="'+data.url+'" class="attached-file inline" title="'+data.description+'">';html=html+'<i class="icon-file-alt bigger-110 middle"></i>';html=html+'<span class="attached-name middle">'+description+'</span>';html=html+'</a>&nbsp;';html=html+'<a href="'+WEBROOT+'communications/download/'+data.name+'" title="Descargar">';html=html+'<i class="icon-download-alt bigger-125 blue"></i>';html=html+'</a>';html=html+'</tr>'
_html=_html+html;});return _html;};$('#btn-add-format').on('click',function(event){event.preventDefault();var categoryId=$('#message-category').val();if(!categoryId)return false;$('#modalAddFormat').modal('show');var data={category_id:categoryId,}
$.ajax({url:WEBROOT+'formats/documentsVisible/',data:data,type:'post',success:function(data){if(data.length<=0){var _html='<p> No hay formatos para esta categoria </p>';}else{var _html=_htmlDocuments(data);}
$('#modalAddFormat').find('div.modal-body').html(_html);},dataType:'json',});});$('#btn-append-format').on('click',function(event){event.preventDefault();$('#modalAddFormat').modal('hide');});$('#message-type').on('change',function(event){event.preventDefault();$('#btn-add-format').addClass('hide');var communicationTypeId=$(this).val();var _htmlOption=function(data){return'<option value=';};$.ajax({url:WEBROOT+'communicationCategories/findByCommunicationTypeId/'+communicationTypeId,type:'post',success:function(data){var _html='<option value="">Seleccione</option>';$.each(data,function(index,val){_html=_html+'<option value="'+index+'">'+val+'</option>';});$('#message-category').html(_html);},dataType:'json',});});$(document).on('change','#message-category',function(event){if($.trim($(this).val()))$('#btn-add-format').removeClass('hide');else $('#btn-add-format').addClass('hide');});$('#btnShowModalCategoryTo').on('click',function(event){event.preventDefault();$('#modalDirectory').modal('show');$.ajax({url:WEBROOT+'communications/directory/',type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);$('#modalDirectory').attr('data-append-to','to');},dataType:'json',});});$('#btnShowModalCategoryCC').on('click',function(event){event.preventDefault();$('#modalDirectory').modal('show');$.ajax({url:WEBROOT+'communications/directory/',type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);$('#modalDirectory').attr('data-append-to','cc');},dataType:'json',});});$(document).on('click','.abcd',function(event){event.preventDefault();var letter=$(this).attr('data-letter');$.ajax({url:WEBROOT+'communications/directory/?l='+letter,type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);},dataType:'json',});return false;});$(document).on('click','.btnFindByQ',function(event){event.preventDefault();var query=$('#search-people').val();if(!query)return false;$.ajax({url:WEBROOT+'communications/directory/?q='+query,type:'post',success:function(data){var html=CE.htmls.directory(data);var h=$(html).height();$('#modalDirectory').find('.modal-body').html(html);},dataType:'json',});return false;});var _htmlSelect=function(entities){var html='<div class="form-group">';html=html+'<label class="col-sm-1 control-label no-padding-right text-right" for="form-field-1">&nbsp;</label>';html=html+'<div class="col-sm-11">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(entities,function(index,entity){var child=entity.ChildEntity;child=child.length;child=(child>0)?1:'';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select></div></div>';return html;}
var _htmlTable=function(data){if(data.length<1)return'<thead><tr><th colspan="6"> No hay datos </th></tr></thead>';var html='<thead>';html=html+'<tr>';html=html+'<th class="center">'
html=html+'<label>';html=html+'<input type="checkbox" class="ace" id="checkbox-select-all"><span class="lbl"></span>';html=html+'</label>'
html=html+' </th>';html=html+'<th>Nombre</th><th>Teléfono</th><th>Móvil</th><th>Unidad</th><th>Web</th></tr></thead>';html=html+'<tbody>';$.each(data,function(index,val){telephone=val.User.telephone?val.User.telephone:' ';celphone=val.User.celphone?val.User.celphone:' ';website=val.Entity.website?val.Entity.website:' ';html=html+'<tr data-user-id="'+val.User.id+'" data-user-name="'+val.User.first_name+' '+val.User.last_name+'" data-user-path="'+val.path+'">';html=html+'<td class="center"><label><input class="ace ckb" type="checkbox"><span class="lbl"></span></label></td>';html=html+'<td>'+val.User.first_name+' '+val.User.last_name+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+val.path+'</td>';if(website!=' ')html=html+'<td><a href="'+website+'" target="_blank"> Ver </a></td>';else html=html+'<td>&nbsp;</td>';});html=html+'</tbody>';return html;}
$(document).on('change','select.s-entity',function(){_this=this;_opt=$(_this).find('option:selected');var hasChild=$(_opt).attr('data-child');var parentId=$(_opt).attr('value');var userGroupId=$('#UserUserGroupId').val();$(_this).parents('.form-group:first').nextAll('.form-group').remove();if(hasChild&&userGroupId!=3){$('.selects-entity').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+parentId+'/',type:'get',success:function(data){var htmlSelect=_htmlSelect(data);$('.selects-entity').find('div.form-group:last').after(htmlSelect);},dataType:'json',complete:function(){$('.selects-entity').find('.i-load').addClass('hide');}});}});$(document).on('click','#btn-find-by-entity',function(){event.preventDefault();var entity=$('option.opt-entity:selected:last').val();$.ajax({url:WEBROOT+'entities/findAllPeople/'+entity+'/',type:'get',success:function(data){var _html=_htmlTable(data);$('#table-2').html(_html);},dataType:'json',});});$(document).on('click','#btn-find-by-group',function(){event.preventDefault();var group=$('option.opt-group:selected:last').val();$.ajax({url:WEBROOT+'groups/findPeopleByGoup/'+group+'/',type:'get',success:function(data){var _html=_htmlTable(data);$('#table-3').html(_html);},dataType:'json',});});$(document).on('click','table th input:checkbox',function(){var that=this;$(this).closest('table').find('tr > td:first-child input:checkbox').each(function(){this.checked=that.checked;$(this).closest('tr').toggleClass('selected');});});$(document).on('click','[type="checkbox"]',function(event){var active=false;$.each($('[type="checkbox"]'),function(index,val){if($(this).is(':checked')){active=true;return false;}});if(active)$('.spn-send-msg').removeClass('hide');else $('.spn-send-msg').addClass('hide');});var _htmlTag=function(data){var html='<span style="margin-top:2px; padding-top:2px; display:inline-block;" class="myTag" id="undefined_1" data-type="user" data-id="'+data.id+'">';html=html+'<span data-rel="tooltip" data-placement="top" title="" data-original-title="'+data.path+'">';html=html+data.name+' &nbsp;&nbsp;';html=html+'</span>';html=html+'<a href="#" class="myTagRemover" id="undefined_Remover_1" tagidtoremove="1" title="" data-original-title="Eliminar">x</a>';hmtl=html+'</span>';return html;}
$(document).on('click','.btn-send-msg',function(event){event.preventDefault();$("input[type=checkbox]:checked").each(function(){if($(this).attr('id')!='checkbox-select-all'){var dt={id:$(this).parents('tr:first').attr('data-user-id'),name:$(this).parents('tr:first').attr('data-user-name'),path:$(this).parents('tr:first').attr('data-user-path')}
var htmlT=_htmlTag(dt);var appendTo=$('#modalDirectory').attr('data-append-to');if(appendTo=='to')$('#content-receivers').append(htmlT);if(appendTo=='cc'){$('#content-tags-receivers-cc').removeClass('hide');$('#content-receivers-cc').append(htmlT);}}});message('Mensaje','Usuario(s) agregado(s)');});$(document).on('click','#modalDirectory ul.nav li a',function(event){event.preventDefault();$("input[type=checkbox]:checked").removeAttr("checked");$('.spn-send-msg').addClass('hide');});$(document).on('click','.tag .close',function(event){event.preventDefault();_tag=this;$(_tag).parents('.tag').remove();});},});;$.extend(CE.communications,{index:function(){var _htmlNewMessage=function(data){var read=(data.Communication.read)?' ':'message-unread';var html='<div class="message-item '+read+'" data-communication-id="'+data.Communication.id+'">';html=html+'<label class="inline">';html=html+'<input type="checkbox" class="ace">';html=html+'<span class="lbl"></span>';html=html+'</label>';if(data.Communication.is_update){html=html+'<i class="message-star icon-circle orange2 c-interaction"></i>';}
else{html=html+'<i class="message-star icon-circle orange2 hide c-interaction"></i>';html=html+'<span class="c-no-interaction" style="width:23px; display:inline-block;">&nbsp;</span>';}
html=html+'<span class="sender view-cmt" title="'+data.SenderEntity.name+'"><small>'+data.SenderEntity.name+'</small></span>';html=html+'<span class="summary view-cmt">';html=html+'<span class="text">'+data.Message.title+'</span>';html=html+'</span>';html=html+'<span class="times pull-right pretty-date-date" data-date="'+data.Trace.created+'"><span class="email-date"><span></span>';html=html+'</div>';return html;}
$('.view-cmt').on('click',function(event){event.preventDefault();_this=this;var draft=$('#message-list').attr('data-communication-draft');var idCommunication=$(this).parent().attr('data-communication-id');if(draft==1)window.location=WEBROOT+'communications/draft/'+idCommunication;else window.location=WEBROOT+'communications/view/'+idCommunication;});(function notificationInteractions(){var datos=[];$.each($('#message-list .message-item'),function(index,message){var id=$(message).attr('data-communication-id');datos.push(id);});var ca={'ids':datos,}
$.ajax({url:WEBROOT+'communications/getNewInteractions/',type:'post',data:ca,success:function(data){$.each(data,function(index,com){if(com.has_interaction){id=com.id;$('.message-item[data-communication-id="'+id+'"] ').find('.c-no-interaction').addClass('hide');$('.message-item[data-communication-id="'+id+'"] ').find('.c-interaction').removeClass('hide');}});},dataType:'json',complete:setTimeout(function(){notificationInteractions()},5000),timeout:2000});})();},addTag:function(value){var name=value;var id='';if(value.match('--')){var str=value.split('--');id=str[0];name=str[1];}
var communicationId=$('#communication').data('communication-id');var userId=$('body').data('user-id');var tag={'user_id':userId,'name':name,'communication_id':communicationId}
var rTag='';if(!communicationId)return false;$.ajax({url:WEBROOT+'tags/add/',type:'post',data:tag,success:function(data){if(data['Request']['status']==200){rTag=data.Tag;}
else{m_error(data['Request']['message']);}},dataType:'json',async:false,error:function(c,v){c(c);c(v);}});return rTag;},view:function(){var _htmlComment=function(data){var html='<div class="timeline-items" style="display:none">';html=html+'<div class="timeline-item clearfix">';html=html+'<div class="timeline-info pretty-date-date" data-date="'+data.Message.created+'">';html=html+'<div class="timeline-info-date">';html=html+'<span class="day"></span>';html=html+'<span class="month"></span>';html=html+'<span class="year"></span>';html=html+'</div>';html=html+'</div>';html=html+'<div class="widget-box transparent collapsed';if(data.approve=='-1')html=html+' border-reject';if(data.approve=='1')html=html+' border-approve';html=html+'">';html=html+'<div class="widget-header widget-header-small">';html=html+'<h5 class="smaller">';html=html+'<span class="grey"><strong>De </strong>'+data.UserSender.first_name+' '+data.UserSender.last_name+'</span>';html=html+'</h5>';html=html+'<h5 class="smaller" style="margin:0px;">';html=html+'<span class="grey"><strong>Para </strong>';var hasCC=false;$.each(data.UserReceivers,function(index,entity){if(entity.type_delivery=='0'){html=html+'<span class="label" data-rel="tooltip" data-placement="top" title="" data-original-title="'+data.EntitiesReceivers[entity.entity_id].name+'">'+entity.first_name+' '+entity.last_name+'</span>&nbsp;';}else{hasCC=true;}});html=html+'</span>';html=html+'</h5>';if(hasCC){html=html+'<h5 class="smaller" style="margin:0px; margin-top:5px;">';html=html+'<span class="grey"><strong>C.C. </strong>';$.each(data.UserReceivers,function(index,entity){if(entity.type_delivery=='1'){html=html+'<span class="label" data-rel="tooltip" data-placement="top" title="" data-original-title="'+data.EntitiesReceivers[entity.entity_id].name+'">'+entity.first_name+' '+entity.last_name+'</span>&nbsp;';}});html=html+'</span>';html=html+'</h5>';}
html=html+'<span class="widget-toolbar no-border">';html=html+'<i class="icon-time bigger-110"></i>';html=html+'<span class="pretty-date-date" data-date="'+data.Message.created+'"><span class="hour"></span></span>';html=html+'</span>';html=html+'<span class="widget-toolbar">';html=html+'<a href="#" data-action="collapse">';html=html+'<i class="icon-chevron-down"></i>';html=html+'</a>';html=html+'</span>';html=html+'</div>';html=html+'<div class="widget-body">';html=html+'<div class="widget-body-inner" style="display: none;">';html=html+'<div class="widget-main" style="padding:2px;" >';html=html+'<div style="background-color:#ffffff; padding:5px;">'+data.Message.content+'</div>';html=html+'<div class="space-6"></div>';html=html+'<div class="hr hr-double"></div>';if(data.Uploads.length>0){html=html+'<div class="widget-toolbox clearfix">';html=html+'<div class="attachment-title">';html=html+'<span class="blue bolder bigger-110">Adjuntos</span>';html=html+'</div>';html=html+'<ul class="attachment-list pull-left list-unstyled">';$.each(data.Uploads,function(index,upload){html=html+'<li>';html=html+'<a target="_blank" href="'+upload.Upload.url+'" class="attached-file inline" title="'+upload.Upload.real_name+'">';html=html+'<i class="icon-file-alt bigger-110 middle"></i>';html=html+'<span class="attached-name middle">'+upload.Upload.real_name+'</span>';html=html+'</a>';html=html+'<div class="action-buttons inline">';html=html+'<a href="'+WEBROOT+'communications/download/'+upload.Upload.name+'" title="Descargar">';html=html+'<i class="icon-download-alt bigger-125 blue"></i>';html=html+'</a>';html=html+'</div>';html=html+'</li>';});html=html+'</ul>';html=html+'</div>';}
html=html+'</div>';html=html+'</div>';if(data.approve!=0){html=html+'<div class="text-center white ';if(data.approve=='-1')html=html+' label-reject ';if(data.approve=='1')html=html+' label-approve ';html=html+'"> ';html=html+'<strong>';if(data.approve=='-1')html=html+' Rechazado ';if(data.approve=='1')html=html+' Aprobado ';html=html+'</strong>';}
html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';return html;};$('#cancelReplyCommunication').on('click',function(event){event.preventDefault();var _this=this;$(_this).addClass('hide');$('#contentReplyCommunication').addClass('hide');$('#replyCommunication').removeClass('hide');});$('#replyCommunication').on('click',function(event){event.preventDefault();var _this=this;$(_this).addClass('hide');$('#contentReplyCommunication').removeClass('hide');$('#cancelReplyCommunication').removeClass('hide');});CE.communications.addcommon();$('.wysiwyg-speech-input').hide();$('[data-rel=tooltip]').tooltip();$('#btn-send-message').on('click',function(event){event.preventDefault();var _btn=this;var btnHtml=$(_btn).html();if($(_btn).attr('disabled'))return false;$(_btn).html('Enviando...');$(_btn).attr('disabled','disabled');$('.btn-fileup').hide();var receivers=[];var files=[];var error=false;if($('#content-receivers > span').length<1){m_error('Debe indicar a quien o quienes va dirigido la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
var approvalAnswer='0';var requireApproval=$('#contentReplyCommunication').attr('data-requires-approval');if(requireApproval=='1'){approvalAnswer=$("input[name='RApproval']:checked").val();if(!approvalAnswer){m_error('Debe indicar si aprueba o rechaza la acción');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}}
$.each($('.files tr'),function(index,file){var idFile=$(file).attr('data-file-id');files.push(idFile);});$.each($('#content-receivers .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'to',};receivers.push(r);});$.each($('#content-receivers-cc .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'cc',};receivers.push(r);});var idCommunication=$('#communication').attr('data-communication-id');var m_private=0;if($('#id-private-message').is(':checked'))m_private=1;var communication={user_id:$('body').attr('data-user-id'),entity_id:$('body').attr('data-user-entity-id'),title:$('#message-title').val(),content:$('#message-content').html(),receivers:receivers,files:files,temporal_id:$('#txtIdMessage').val(),communication_id:idCommunication,message_private:m_private,approval:approvalAnswer,}
$.ajax({url:WEBROOT+'communications/reply/'+idCommunication,type:'post',data:communication,success:function(data){if(data['Request']['status']==200){$('#contentReplyCommunication').hide();$('#cancelReplyCommunication').hide();var html='';$.each(data.Messages,function(index,val){html=html+_htmlComment(val);});$('#communication').find('.timeline-label:first').after(html);$('#communication').find('.timeline-items:first').fadeIn('fast',function(){});prettydate();}
else{m_error(data['Request']['message']);$.each($('.files tr'),function(index,tr){$(tr).find('.delete button').click();});$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();}},dataType:'json',complete:function(){}});});var userId=$('body').data('user-id');var tag_input=$('#pruebados');if(!(/msie\s*(8|7|6)/.test(navigator.userAgent.toLowerCase())))
{tag_input.tag({placeholder:tag_input.attr('placeholder'),source:function(query,process){$.post(WEBROOT+'tags/findTags',{q:query,user_id:userId},function(data){process($.map(data,function(item){var name=item.Tag.id+'--'+item.Tag.name;return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'</div>';html=html+'</div>';return html}},});}
else{tag_input.after('<textarea id="'+tag_input.attr('id')+'" name="'+tag_input.attr('name')+'" rows="3">'+tag_input.val()+'</textarea>').remove();}
$(document).on('click','.tag .close',function(event){event.preventDefault();_tag=this;var tagId=$(_tag).parent().data('id');$.ajax({url:WEBROOT+'tags/delete/'+tagId,type:'post',success:function(data){if(data['Request']['status']!=200){m_error(data['Request']['message']);}else{$(_tag).parents('.tag').remove();}},dataType:'json',async:false});});}});;$.extend(CE.communications,{draft:function(){CE.communications.addcommon();$(document).on('click','.rm-nw',function(event){event.preventDefault();$(this).parent('span').remove();});var userId=$('body').data('user-id');var tag_input=$('#pruebados');if(!(/msie\s*(8|7|6)/.test(navigator.userAgent.toLowerCase())))
{tag_input.tag({placeholder:tag_input.attr('placeholder'),source:function(query,process){$.post(WEBROOT+'tags/findTags',{q:query,user_id:userId},function(data){process($.map(data,function(item){var name=item.Tag.id+'--'+item.Tag.name;return name;}));},'json');this.highlighter=function(item){var elemento=item.split('--');var id=elemento[0];var name=elemento[1];var type=elemento[2];var path=elemento[3];var html='<div class="box-hl" data-id="'+id+'">';html=html+'<div class="box-hl-content">';html=html+'<div class="bx-name">'+name+'</div>';html=html+'</div>';html=html+'</div>';return html}},});}
else{tag_input.after('<textarea id="'+tag_input.attr('id')+'" name="'+tag_input.attr('name')+'" rows="3">'+tag_input.val()+'</textarea>').remove();}
$('#btn-send-message').on('click',function(event){event.preventDefault();var _btn=this;var btnHtml=$(_btn).html();if($(_btn).attr('disabled'))return false;$(_btn).html('Enviando...');$(_btn).attr('disabled','disabled');$('.btn-fileup').hide();var receivers=[];var receiverscc=[];var files=[];var tags=[];var formats=[];var error=false;if(($('#content-receivers > span').length<1)&&!$('#message-title').val()){m_error('Debe indicar a quien o quienes va dirigido la comunicación y el asunto de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
$.each($('.files tr'),function(index,file){var idFile=$(file).attr('data-file-id');files.push(idFile);});$.each($('#content-receivers .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'to',};var pre=$(receiver).attr('data-pre');if(!pre)receivers.push(r);});$.each($('#content-receivers-cc .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'cc',};var pre=$(receiver).attr('data-pre');if(!pre)receivers.push(r);});$.each($('#contentTags .tag'),function(index,span){var tag=$(span).html();var aux=tag.split('<button');var pre=$(span).attr('data-pre');if(!pre)tags.push(aux[0]);});$.each($('#tbl-formats tr'),function(index,tr){var id=$(tr).attr('data-document-id');formats.push(id);});var m_private=0;if($('#id-private-message').is(':checked'))m_private=1;var communicationId=$('#communication').attr('data-communication-id');var messageId=$('#communication').attr('data-message-id');var communication={user_id:$('body').attr('data-user-id'),entity_id:$('body').attr('data-user-entity-id'),title:$('#message-title').val(),content:$('#message-content').html(),receivers:receivers,files:files,temporal_id:$('#txtIdMessage').val(),communication_category_id:$('#message-category').val(),communication_type_id:$('#message-type').val(),tags:tags,formats:formats,action:$('input[name="message-action"]:checked').val(),message_private:m_private,draft:0,pre_save:1,communication_id:communicationId,message_id:messageId}
$.ajax({url:WEBROOT+'communications/edit/'+communicationId,type:'post',data:communication,success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'communications/';}
else{m_error(data['Request']['message']);$.each($('.files tr'),function(index,tr){$(tr).find('.delete button').click();});$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();}},dataType:'json',});});$('#btn-send-draft').on('click',function(event){event.preventDefault();var _btn=this;var btnHtml=$(_btn).html();if($(_btn).attr('disabled'))return false;$(_btn).html('Enviando...');$(_btn).attr('disabled','disabled');$('.btn-fileup').hide();var receivers=[];var receiverscc=[];var files=[];var tags=[];var formats=[];var error=false;if(($('#content-receivers > span').length<1)&&!$('#message-title').val()){m_error('Debe indicar a quien o quienes va dirigido la comunicación y el asunto de la comunicación');$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();return false;}
$.each($('.files tr'),function(index,file){var idFile=$(file).attr('data-file-id');files.push(idFile);});$.each($('#content-receivers .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'to',};var pre=$(receiver).attr('data-pre');if(!pre)receivers.push(r);});$.each($('#content-receivers-cc .myTag'),function(index,receiver){var r={id:$(receiver).attr('data-id'),type:$(receiver).attr('data-type'),deliverytype:'cc',};var pre=$(receiver).attr('data-pre');if(!pre)receivers.push(r);});$.each($('#contentTags .tag'),function(index,span){var tag=$(span).html();var aux=tag.split('<button');var pre=$(span).attr('data-pre');if(!pre)tags.push(aux[0]);});$.each($('#tbl-formats tr'),function(index,tr){var id=$(tr).attr('data-document-id');formats.push(id);});var m_private=0;if($('#id-private-message').is(':checked'))m_private=1;var communicationId=$('#communication').attr('data-communication-id');var messageId=$('#communication').attr('data-message-id');var communication={user_id:$('body').attr('data-user-id'),entity_id:$('body').attr('data-user-entity-id'),title:$('#message-title').val(),content:$('#message-content').html(),receivers:receivers,files:files,temporal_id:$('#txtIdMessage').val(),communication_category_id:$('#message-category').val(),communication_type_id:$('#message-type').val(),tags:tags,formats:formats,action:$('input[name="message-action"]:checked').val(),message_private:m_private,draft:1,pre_save:1,communication_id:communicationId,message_id:messageId}
$.ajax({url:WEBROOT+'communications/edit/'+communicationId,type:'post',data:communication,success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'communications/?draft=1';}
else{m_error(data['Request']['message']);$.each($('.files tr'),function(index,tr){$(tr).find('.delete button').click();});$(_btn).html(btnHtml);$(_btn).removeAttr('disabled');$('.btn-fileup').show();}},dataType:'json',});});var _htmlDocuments=function(data){var _html='';$.each(data,function(index,val){data=val.Upload;description=val.Format.name;var html='<tr class="tr-format" data-document-id="'+data.id+'" data-document-name="'+data.description+'">';html=html+'<td>';html=html+'<a target="_blank" href="'+data.url+'" class="attached-file inline" title="'+data.description+'">';html=html+'<i class="icon-file-alt bigger-110 middle"></i>';html=html+'<span class="attached-name middle">'+description+'</span>';html=html+'</a>&nbsp;';html=html+'<a href="'+WEBROOT+'communications/download/'+data.name+'" title="Descargar">';html=html+'<i class="icon-download-alt bigger-125 blue"></i>';html=html+'</a>';html=html+'</tr>'
_html=_html+html;});return _html;};$('#btn-add-format').on('click',function(event){event.preventDefault();var categoryId=$('#message-category').val();if(!categoryId)return false;$('#modalAddFormat').modal('show');var data={category_id:categoryId,}
$.ajax({url:WEBROOT+'formats/documentsVisible/',data:data,type:'post',success:function(data){if(data.length<=0){var _html='<p> No hay formatos para esta categoria </p>';}else{var _html=_htmlDocuments(data);}
$('#modalAddFormat').find('div.modal-body').html(_html);},dataType:'json',});});$('#btn-append-format').on('click',function(event){event.preventDefault();$('#modalAddFormat').modal('hide');});$('#message-type').on('change',function(event){event.preventDefault();$('#btn-add-format').addClass('hide');var communicationTypeId=$(this).val();var _htmlOption=function(data){return'<option value=';};$.ajax({url:WEBROOT+'communicationcategories/findByCommunicationTypeId/'+communicationTypeId,type:'post',success:function(data){var _html='<option value="">Seleccione</option>';$.each(data,function(index,val){_html=_html+'<option value="'+index+'">'+val+'</option>';});$('#message-category').html(_html);},dataType:'json',});});$('#message-category').on('click',function(event){event.preventDefault();if($.trim($(this).val()))$('#btn-add-format').removeClass('hide');else $('#btn-add-format').addClass('hide');});$('#btnShowModalCategoryTo').on('click',function(event){event.preventDefault();$('#modalDirectory').modal('show');$.ajax({url:WEBROOT+'communications/directory/',type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);$('#modalDirectory').attr('data-append-to','to');},dataType:'json',});});$('#btnShowModalCategoryCC').on('click',function(event){event.preventDefault();$('#modalDirectory').modal('show');$.ajax({url:WEBROOT+'communications/directory/',type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);$('#modalDirectory').attr('data-append-to','cc');},dataType:'json',});});$(document).on('click','.abcd',function(event){event.preventDefault();var letter=$(this).attr('data-letter');$.ajax({url:WEBROOT+'communications/directory/?l='+letter,type:'post',success:function(data){var html=CE.htmls.directory(data);$('#modalDirectory').find('.modal-body').html(html);},dataType:'json',});return false;});$(document).on('click','.btnFindByQ',function(event){event.preventDefault();var query=$('#search-people').val();if(!query)return false;$.ajax({url:WEBROOT+'communications/directory/?q='+query,type:'post',success:function(data){var html=CE.htmls.directory(data);var h=$(html).height();$('#modalDirectory').find('.modal-body').html(html);},dataType:'json',});return false;});var _htmlSelect=function(entities){var html='<div class="form-group">';html=html+'<label class="col-sm-1 control-label no-padding-right text-right" for="form-field-1">&nbsp;</label>';html=html+'<div class="col-sm-11">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(entities,function(index,entity){var child=entity.ChildEntity;child=child.length;child=(child>0)?1:'';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select></div></div>';return html;}
var _htmlTable=function(data){if(data.length<1)return'<thead><tr><th colspan="6"> No hay datos </th></tr></thead>';var html='<thead>';html=html+'<tr>';html=html+'<th class="center">'
html=html+'<label>';html=html+'<input type="checkbox" class="ace" id="checkbox-select-all"><span class="lbl"></span>';html=html+'</label>'
html=html+' </th>';html=html+'<th>Nombre</th><th>Teléfono</th><th>Móvil</th><th>Unidad</th><th>Web</th></tr></thead>';html=html+'<tbody>';$.each(data,function(index,val){telephone=val.User.telephone?val.User.telephone:' ';celphone=val.User.celphone?val.User.celphone:' ';website=val.Entity.website?val.Entity.website:' ';html=html+'<tr data-user-id="'+val.User.id+'" data-user-name="'+val.User.first_name+' '+val.User.last_name+'" data-user-path="'+val.path+'">';html=html+'<td class="center"><label><input class="ace ckb" type="checkbox"><span class="lbl"></span></label></td>';html=html+'<td>'+val.User.first_name+' '+val.User.last_name+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+telephone+'</td>';html=html+'<td>'+val.path+'</td>';if(website!=' ')html=html+'<td><a href="'+website+'" target="_blank"> Ver </a></td>';else html=html+'<td>&nbsp;</td>';});html=html+'</tbody>';return html;}
$(document).on('change','select.s-entity',function(){_this=this;_opt=$(_this).find('option:selected');var hasChild=$(_opt).attr('data-child');var parentId=$(_opt).attr('value');var userGroupId=$('#UserUserGroupId').val();$(_this).parents('.form-group:first').nextAll('.form-group').remove();if(hasChild&&userGroupId!=3){$('.selects-entity').find('.i-load').removeClass('hide');$.ajax({url:WEBROOT+'entities/children/'+parentId+'/',type:'get',success:function(data){var htmlSelect=_htmlSelect(data);$('.selects-entity').find('div.form-group:last').after(htmlSelect);},dataType:'json',complete:function(){$('.selects-entity').find('.i-load').addClass('hide');}});}});$(document).on('click','#btn-find-by-entity',function(){event.preventDefault();var entity=$('option.opt-entity:selected:last').val();$.ajax({url:WEBROOT+'entities/findAllPeople/'+entity+'/',type:'get',success:function(data){var _html=_htmlTable(data);$('#table-2').html(_html);},dataType:'json',});});$(document).on('click','table th input:checkbox',function(){var that=this;$(this).closest('table').find('tr > td:first-child input:checkbox').each(function(){this.checked=that.checked;$(this).closest('tr').toggleClass('selected');});});$(document).on('click','[type="checkbox"]',function(event){var active=false;$.each($('[type="checkbox"]'),function(index,val){if($(this).is(':checked')){active=true;return false;}});if(active)$('.spn-send-msg').removeClass('hide');else $('.spn-send-msg').addClass('hide');});var _htmlTag=function(data){var html='<span style="margin-top:2px; padding-top:2px; display:inline-block;" class="myTag" id="undefined_1" data-type="user" data-id="'+data.id+'">';html=html+'<span data-rel="tooltip" data-placement="top" title="" data-original-title="'+data.path+'">';html=html+data.name+' &nbsp;&nbsp;';html=html+'</span>';html=html+'<a href="#" class="myTagRemover" id="undefined_Remover_1" tagidtoremove="1" title="" data-original-title="Eliminar">x</a>';hmtl=html+'</span>';return html;}
$(document).on('click','.btn-send-msg',function(event){event.preventDefault();$("input[type=checkbox]:checked").each(function(){var dt={id:$(this).parents('tr:first').attr('data-user-id'),name:$(this).parents('tr:first').attr('data-user-name'),path:$(this).parents('tr:first').attr('data-user-path')}
var htmlT=_htmlTag(dt);var appendTo=$('#modalDirectory').attr('data-append-to');if(appendTo=='to')$('#content-receivers').append(htmlT);if(appendTo=='cc'){$('#content-tags-receivers-cc').removeClass('hide');$('#content-receivers-cc').append(htmlT);}});});$(document).on('click','#modalDirectory ul.nav li a',function(event){event.preventDefault();$("input[type=checkbox]:checked").removeAttr("checked");$('.spn-send-msg').addClass('hide');});$(document).on('click','.tag .close',function(event){event.preventDefault();_tag=this;var idTag=$(_tag).attr('data-tag-id');if(idTag){$.ajax({url:WEBROOT+'tags/delete/'+idTag+'/',type:'post',data:{id:idTag},success:function(data){if(data.Request.status==200){$(_tag).parents('.tag').remove();}},dataType:'json',});}
else{$(_tag).parents('.tag').remove();}});$(document).on('click','.btn-delete-preupload',function(event){event.preventDefault();_this=this;var idUpload=$(_this).attr('data-file-id');if(idUpload){$.ajax({url:WEBROOT+'communications/deletePreUpload/'+idUpload+'/',type:'post',data:{id:idUpload},success:function(data){if(data.Request.status==200){$(_this).parents('tr:first').fadeOut('fast');}
if(data.Request.status==300){m_error(data['Request']['message']);}},dataType:'json',});}});$.each($('#contentTags .tag'),function(index,val){var w=$(val).width();w1=w*0.2;$(val).width(w+w1);});},});;$.extend(CE.tags,{index:function(){var filterTag=function(text){$.each($('tbody tr'),function(){var name=$(this).find('.td-name').attr('data-tag-name');if(name){name=name.toLowerCase();if(name.match(text))$(this).fadeIn();else $(this).fadeOut();}})};var timer=0;$('#searchTag').keyup(function(){clearTimeout(timer);timer=setTimeout(function(){var q=$('#searchTag').val();filterTag(q);},250)});}});;$.extend(CE.formats,{init:function(){$('#message-type').on('change',function(event){event.preventDefault();var communicationTypeId=$(this).val();var _htmlOption=function(data){return'<option value=';};$.ajax({url:WEBROOT+'communicationCategories/findByCommunicationTypeId/'+communicationTypeId,type:'post',success:function(data){var _html='<option value="">Seleccione</option>';$.each(data,function(index,val){_html=_html+'<option value="'+index+'">'+val+'</option>';});$('#message-category').html(_html);},dataType:'json',});});$('.btn-fileup').on('click',function(){$('.btn-fileup-h').click();});$('#isDocument').val('1');$('.btn-fileup-h').on('change',function(event){setTimeout(function(){$.each($('.table-documents tr'),function(index,tr){var dT=new Date();var dateT=dT.getDate()+''+(dT.getMonth()+1)+''+dT.getFullYear()+''+dT.getHours()+''+dT.getMinutes()+''+dT.getSeconds();$('#description').val(dateT);$('#inf-format').attr('data-desc-upload',dateT);$('.btn-subir').click();$('.btn-fileup').hide();});},500);});$(document).on('click','.btn-subir',function(event){event.preventDefault();$('td.start').find('button').click();});$(document).on('click','.btn-prueba',function(event){event.preventDefault();$('.btn-fileup').show();});$('.btn-fileup-h').removeAttr('multiple');$('.btn-fileup-h').attr('name','files');},index:function(){$(document).on('click','[type="checkbox"] ',function(event){_tr=$(this).parents('tr:first');_this=$(this);if($(this).attr('checked')){$(this).removeAttr('checked');}else{$(this).attr('checked','checked');}
var visible=$(this).attr('checked')?'1':'0';var doc={id:$(this).parents('tr:first').attr('data-document-id'),visible:visible}
$.ajax({url:WEBROOT+'formats/updateVisible/',type:'post',data:doc,success:function(data){if(data['Request']['status']==200){}
else{m_error(data['Request']['message']);$(_this).click();}},dataType:'json',});});},add:function(){$('#addFormat').on('click',function(event){event.preventDefault();if($('.btn-fileup').is(':visible')){m_error('Debe seleccionar el archivo');return false;}
var name=$('#FormatName').val();var type=$('#message-type').val();var category=$('#message-category').val();var active=$('#formatVisible').val();var descUpload=$('#inf-format').attr('data-desc-upload')
if(!name||!category||!type||!active){m_error('Debe llenar todos los datos');return false;}
var data={name:name,communication_type_id:type,communication_category_id:category,visible:active,desc_upload:descUpload}
$.ajax({url:WEBROOT+'formats/add/',data:data,type:'post',success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'formats/';}
else{m_error(data['Request']['message']);}},dataType:'json',});});},edit:function(){$('.btn-fileup').hide();$('#delete-prev-upload').on('click',function(event){event.preventDefault();$('#prev-upload').fadeOut('fast',function(){$('.btn-fileup').show();});});$('#editFormat').on('click',function(event){event.preventDefault();if($('.btn-fileup').is(':visible')){m_error('Debe seleccionar el archivo');return false;}
var id=$('#FormatId').val();var name=$('#FormatName').val();var type=$('#message-type').val();var category=$('#message-category').val();var active=$('#formatVisible').val();var descUpload=$('#inf-format').attr('data-desc-upload')
if(!name||!category||!type||!active){m_error('Debe llenar todos los datos');return false;}
var data={id:id,name:name,communication_type_id:type,communication_category_id:category,visible:active,desc_upload:descUpload}
$.ajax({url:WEBROOT+'formats/edit/'+id,data:data,type:'post',success:function(data){if(data['Request']['status']==200){window.location=WEBROOT+'formats/';}
else{m_error(data['Request']['message']);}},dataType:'json',});});}});;$.extend(CE.htmls,{directory:function(data){var html='<div class="col-xs-12">';var html='<div>';html=html+'<div class="widget-box transparent">';html=html+'<div class="widget-header">';html=html+'<div class="widget-toolbar no-border" style="float:left;">';html=html+'<ul class="nav nav-tabs" id="myTab2">';html=html+'<li class="active">';html=html+'<a data-toggle="tab" href="#persons">Personas</a>';html=html+'</li>';html=html+'<li class="">';html=html+'<a data-toggle="tab" href="#profile2">Entidades</a>';html=html+'</li>';html=html+'<li class="">';html=html+'<a data-toggle="tab" href="#groups">Grupos</a>';html=html+'</li>';html=html+'</ul>';html=html+'</div>';html=html+'</div>';html=html+'<div class="widget-body">';html=html+'<div class="widget-main padding-12 no-padding-left no-padding-right">';html=html+'<div class="tab-content padding-4">';html=html+'<div id="persons" class="tab-pane in active">';html=html+'<div class="row">';html=html+'<div class="col-xs-6">';html=html+'<div class="input-group">';html=html+'<input type="text" placeholder="Buscar ..." class="form-control search-people" id="search-people" autocomplete="off" name="q">';html=html+'<span class="input-group-btn">';html=html+'<button class="btn btn-sm btn-default btnFindByQ" type="button" id="btnFindByQ">';html=html+'<i class="icon-search bigger-110"></i>';html=html+'</button>';html=html+'</span>';html=html+'</div>';html=html+'</div>';html=html+'<div class="col-xs-6">';html=html+'<div class="pull-right spn-send-msg hide">';html=html+'<button class="btn-send-msg btn btn-info" type="button" title="" data-original-title="Agregar a la comunicación"><i class=" icon-envelope bigger-130"></i></button>';html=html+'</div>';html=html+'</div>';html=html+'<br><br>';html=html+'<div class="col-xs-12">';html=html+'<div class="message-container">';html=html+'<div id="id-message-list-navbar" class="message-navbar align-center clearfix">';html=html+'<div class="message-bar">';html=html+'<div class="message-infobar" id="id-message-infobar">';html=html+'<span class="blue bigger-150">&nbsp;</span>';html=html+'</div>';html=html+'</div>';html=html+'<div>';html=html+'<div>';html=html+'<span class="abc "><a class="abcd" data-letter="a">A</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="b">B</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="c">C</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="d">D</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="e">E</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="f">F</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="g">G</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="h">H</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="i">I</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="j">J</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="k">K</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="l">L</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="m">M</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="n">N</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="ñ">Ñ</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="o">O</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="p">P</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="q">Q</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="r">R</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="s">S</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="t">T</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="u">U</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="v">V</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="w">W</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="x">X</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="y">Y</a></span>';html=html+'<span class="abc "><a class="abcd" data-letter="z">Z</a></span>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'<div class="row">';html=html+'<div class="col-xs-12">';html=html+'<div class="table-responsive">';html=html+'<table id="sample-table-1" class="table table-striped table-bordered table-hover">';html=html+'<thead>';html=html+'<tr>';html=html+'<th class="center">';html=html+'<label><input type="checkbox" class="ace" id="checkbox-select-all"><span class="lbl"></span></label>';html=html+'</th>';html=html+'<th>Nombre</th>';html=html+'<th>Apellidos</th>';html=html+'<th>Teléfono</th>';html=html+'<th>Móvil</th>';html=html+'<th>Unidad</th>';html=html+'<th>Correo</th>';html=html+'</tr>';html=html+'</thead>';html=html+'<tbody>';$.each(data.Users,function(index,user){html=html+'<tr data-user-id="'+user.User.id+'" data-user-name="'+user.User.first_name+' '+user.User.last_name+'" data-user-path="'+user.path+'">';html=html+'<td class="text-center">';html=html+'<label class="middle">';html=html+'<input class="ace" type="checkbox" id="id-disable-check">';html=html+'<span class="lbl">&nbsp;</span>';html=html+'</label>';html=html+'</td>';html=html+'<td>'+user.User.first_name+'</td>';html=html+'<td>'+user.User.last_name+'</td>';if(user.User.telephone)html=html+'<td>'+user.User.telephone+'</td>';else html=html+'<td>&nbsp;</td>';if(user.User.celphone)html=html+'<td>'+user.User.celphone+'</td>';else html=html+'<td>&nbsp</td>';html=html+'<td>'+user.path+'</td>';html=html+'<td>'+user.User.email+'</td>';html=html+'</tr>';});if((data.Users).length<1){html=html+'<tr>';html=html+'<td colspan="7" class="text-center"> No hay datos que mostrar </td>';html=html+'</tr>';}
html=html+'</tbody>';html=html+'</table>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'<div id="profile2" class="tab-pane">';html=html+'<div class="selects-entity">';html=html+'<div class="form-group">';html=html+'<label class="col-sm-1 control-label no-padding-right text-right" for="form-field-1"> Entidad </label>';html=html+'<div class="col-sm-11 ">';html=html+'<select name="entity_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(data.Entities,function(index,entity){var child=((entity.ChildEntity).length>0)?'1':'0';html=html+'<option class="opt-entity" value="'+entity.Entity.id+'" data-child="'+child+'">'+entity.Entity.name+'</option>';});html=html+'</select>';html=html+'</div>';html=html+'</div>';html=html+'<div style="text-align:center;"><i class="i-load hide icon-refresh icon-spin blue"></i></div>';html=html+'</div>';html=html+'<div class=" btns">';html=html+'<span class="spn-send-msg pull-right hide">';html=html+'<button class="btn-send-msg btn btn-info" type="button" title="Agregar a la comunicación">';html=html+'<i class=" icon-envelope bigger-130"></i>';html=html+'</button>&nbsp;';html=html+'</span>';html=html+'<span class="pull-right">';html=html+'<button id="btn-find-by-entity" class="btn btn-info" type="button">';html=html+'Buscar';html=html+'</button>&nbsp;';html=html+'</span>';html=html+'</div>';html=html+'<div class="row">';html=html+'<div class="col-xs-12">';html=html+'<br>';html=html+'<div class="table-responsive">';html=html+'<table id="table-2" class="table table-striped table-bordered table-hover"></table>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'<div id="groups" class="tab-pane">';html=html+'<div class="selects-group">';html=html+'<div class="form-group">';html=html+'<label class="col-sm-1 control-label no-padding-right text-right" for="form-field-1"> Grupo </label>';html=html+'<div class="col-sm-11 ">';html=html+'<select name="group_id" class="col-xs-10 col-sm-5 s-entity">';html=html+'<option value="0">Seleccione</option>';$.each(data.Groups,function(index,group){html=html+'<option class="opt-group" value="'+index+'" >'+group+'</option>';});html=html+'</select>';html=html+'</div>';html=html+'</div>';html=html+'<div style="text-align:center;"><i class="i-load hide icon-refresh icon-spin blue"></i></div>';html=html+'</div>';html=html+'<div class=" btns">';html=html+'<span class="spn-send-msg pull-right hide">';html=html+'<button class="btn-send-msg btn btn-info" type="button" title="Agregar a la comunicación">';html=html+'<i class=" icon-envelope bigger-130"></i>';html=html+'</button>&nbsp;';html=html+'</span>';html=html+'<span class="pull-right">';html=html+'<button id="btn-find-by-group" class="btn btn-info" type="button">';html=html+'Buscar';html=html+'</button>&nbsp;';html=html+'</span>';html=html+'</div>';html=html+'<div class="row">';html=html+'<div class="col-xs-12">';html=html+'<br>';html=html+'<div class="table-responsive">';html=html+'<table id="table-3" class="table table-striped table-bordered table-hover"></table>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';html=html+'</div>';return html;}});